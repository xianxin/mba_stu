<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>我的课表</title>
<link href="css/common.css" rel="stylesheet" type="text/css" />
<link href="css/style.css" rel="stylesheet" type="text/css" />
<link href="css/easydialog.css" rel="stylesheet" type="text/css" />
<script src="js/jquery-1.7.min.js" language="javascript" type="text/javascript"></script>
<script src='js/jslayer.js'></script>
<script>
	var psc_url = '';
	function setCurrent(){
		;
	}
</script>

</head>
<body>
<div class="hder">
	<div class="hder_top">
		<div class="hder_l">
			<a href="#" title="上海交通大学" class="fl" style="margin-right:10px; display:inline;">
				<img src="images/logo.png" width="303" height="48">
			</a>
			<span class="fl">

        学生系统

      </span>
		</div>
		<div class="hder_r">
			<p>
				欢迎 <span>李晓京</span>，今天是：<span>2014年4月12日</span> |
				<a href="#">安全退出</a> 
			</p>
		</div>
	</div>
	<div class="hder_nav">
		<div class="nav">
			<table class="f4 nav_table" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td>
						<div class="nav_list"><a class="nav_a" href="#">首页</a>
						</div>
					</td>
					<td>
						<div class="nav_list"><a class="nav_a" href="#">我的课程</a>
							<ul class="nav_ul2">
								<li class="nav_li2" style="border:none;"><a href="#" class="nav_a2">培养计划</a>
								</li>
								<li class="nav_li2"><a href="#" class="nav_a2 nav_carent">我的课表</a>
								</li>
								<li class="nav_li2"><a href="#" class="nav_a2">MBA选课</a>
								</li>
								<li class="nav_li2"><a href="#" class="nav_a2">课程/学籍申请调整</li>

     </ul>

    </div>

    </td>

    <td>

    <div class="nav_list"><a class="nav_a" href="#">我的事务</a>
									<ul class="nav_ul2">
										<li class="nav_li2" style="border:none;"><a href="#" class="nav_a2">二级导航</a>
										</li>
										<li class="nav_li2"><a href="#" class="nav_a2">二级导航</a>
										</li>
										<li class="nav_li2"><a href="#" class="nav_a2">二级导航</a>
										</li>
									</ul>
						</div>
					</td>
					<td>
						<div class="nav_list"><a class="nav_a" href="#">活动预告</a>
							<ul class="nav_ul2">
								<li class="nav_li2" style="border:none;"><a href="#" class="nav_a2">二级导航</a>
								</li>
								<li class="nav_li2"><a href="#" class="nav_a2">二级导航</a>
								</li>
								<li class="nav_li2"><a href="#" class="nav_a2">二级导航</a>
								</li>
							</ul>
						</div>
					</td>
					<td>
						<div class="nav_list"><a class="nav_a" href="#">常用文档</a>
						</div>
					</td>
					<td>
						<div class="nav_list"><a class="nav_a" href="#">个人中心</a>
						</div>
					</td>
				</tr>
			</table>
		</div>
		<script src="js/public.js" language="javascript" type="text/javascript"></script>
	</div>
</div>

<!--TODO : startCopy-->

<script type="text/javascript" src="js/angular.min.js"></script>
<script src="js/public2.js" ></script>
<script src="js/easydialog.min.js" language="javascript" type="text/javascript"></script>
<!--[if lte IE 8]>
    <script type="text/javascript" src="js/json3.min.js" ></script>
    <script>
	    document.createElement('ng-include');
        document.createElement('ng-pluralize');
        document.createElement('ng-view');
        document.createElement('ng:include');
        document.createElement('ng:pluralize');
        document.createElement('ng:view');
	</script>
<![endif]-->
<style>
	.schedule_cont_pop table td {
		padding: 2px;
	}
	#imgBox_CourseAttendance .dialog_wdkb_bt td{
		padding-left: 20px; padding-right: 5px;
		text-align: left;
	}
</style>
<div class="s_main">
	
	<!--left menu-->
	<div id="left_div_id">
		<script>$("#left_div_id").load("/mbastu/_menu/menu_1082.html",function(){setCurrent('我的课表');});</script>
	</div>
	
	<div class="s_main_r" id='ng-app' ng-app='ScheduleApp'>
		<div class="schedule_cont" ng-controller='ScheduleController'>
			<div class="schedule_cont_bt">
				<h2>我的课表</h2>
				<div class="schedule_cont_xh">
					<span class="schedule_cont_xh_one">学号：<em ng-bind='studentSchedule.studentId'></em></span>
					<span class="schedule_cont_xh_two">班级：<em ng-bind='studentSchedule.className'></em></span>
					<span class="schedule_cont_xh_three">预计毕业日期：<em ng-bind='studentSchedule.graDate'></em></span>
					<div class="clear"></div>
				</div>
				<div class="schedule_cont_pop">
					<table width="736" border="0" cellpadding="0" cellspacing="0">
						<tr>
							<td height="45" width="84">课程名称</td>
							<td width="38">学时</td>
							<td width="38">学分</td>
							<td width="65">任课教师</td>
							<td width="100">上课日期</td>
							<td width="66">起止周</td>
							<td width="90">停课及原因</td>
							<td width="104">补课时间
								<br>及原因
							</td>
							<td width="120">考试安排</td>
						</tr>

						<tr ng-repeat='course in studentSchedule.courseList'>
							<td>{{course.courseName}}
								<br />
								<a href='javascript:void(0)' title="" class="scp_kczl" ng-click="openCourseReference(course.courseID)">课程资料</a>
								<br />
								<a href='javascript:void(0)' title="" class="scp_kczl" ng-click="openCourseAttendance(course.courseID)">查看考勤</a>
							</td>
							<td ng-bind-html='course.courseHours | checkTdEmpty'></td>
							<td ng-bind-html='course.credit | checkTdEmpty'></td>
							<td ng-bind-html='course.teacher | checkTdEmpty'></td>
							<td><a href='javascript:void(0)' title="" class="scp_kczl" ng-click="openCourseTime($index)">查看上课时间</a></td>
							<td ng-bind-html='course.courseWeek | checkTdEmpty'></td>
							<td ng-bind-html='course.courseSuspend | checkTdEmpty'></td>
							<td ng-bind-html='course.courseMarkup | checkTdEmpty'></td>
							<td ng-if="course.IsOpen == 'N'">待定</td>
							<td ng-if="course.IsOpen == 'Y' && course.IsPlan == 'TRUE'" ng-bind-html='course.examPlan | checkTdEmpty'></td>
							<td ng-if="course.IsOpen == 'Y' && course.IsPlan == 'FALSE'">&nbsp;课程评估率＜95%
								<br>不能查看考试安排
								<br>
								<a href title="" class="scp_kczl" ng-click="openUnevaluatedStudentList(course.courseID)">查看未完成<br>评估学生</a>&nbsp;
							</td>
						</tr>

					</table>
				</div>
			</div>

			<div class="dialog_wdkb" id="imgBox_CourseAttendance" style="display:none;" >
				
				<div class="dialog_wdkb_mar">
					<table width="670" border="0" cellspacing="0" cellpadding="0" class="dialog_wdkb_bt">
						<tr>
							<td height="32">学年： <span ng-bind='courseAttendance.year'></span>
							</td>
							<td>学期： <span ng-bind='courseAttendance.term'></span>
							</td>
							<td>考勤导入日期： <span ng-bind='courseAttendance.importTime'></span></td>
						</tr>
						<tr>
							<td height="32">授课教师： <span ng-bind='courseAttendance.teacher'></span>
							</td>
							<td colspan="2">课程名称： <span ng-bind='courseAttendance.courseName'></span>
							</td>
						</tr>
					</table>

					<table width="670" border="0" cellspacing="0" cellpadding="0" class="dialog_wdkb_nr">
						<tr>
							<td height="32">考勤日期</td>
							<td>上课开始时间</td>
							<td>上课结束时间</td>
							<td>打卡时间</td>
							<td>状态</td>
						</tr><tr ng-repeat='attendance in  courseAttendance.KQList'>
							<td height="32" ng-bind-html='attendance.KQDate | checkTdEmpty'></td>
							<td ng-bind-html='attendance.startTime | checkTdEmpty'></td>
							<td ng-bind-html='attendance.endTime | checkTdEmpty'></td>
							<td ng-bind-html='attendance.clockTime | checkTdEmpty'></td>
							<td ng-bind-html='attendance.status | checkTdEmpty'></td>
						</tr>
					</table>
					<div class="dialog_wdkb_mar_fh">
						<a href="#" title="" id="btnClose" onclick="easyDialog.close();">返回</a>
					</div>
				</div>
			</div>
			
			<div class="dialog_wdkb" id="imgBox_UnevaluatedStudentList" style="display:none;" >
				<div class="dialog_wdkb_mar">
					<table width="670" border="0" cellspacing="0" cellpadding="0" class="dialog_wdkb_bt">
						<tr>
							<td height="32" style="text-align: center; padding: 15px 20px;">课程号： <span ng-bind='unEvaluation.courseID'></span>
							</td>
							<td style="text-align: center; padding: 5px 20px;">课程名： <span ng-bind='unEvaluation.courseName'></span>
							</td>
						</tr>
					</table>
					<br />
					<div class='dialog_wdkb_nr_wrapper'>
					<table width="670" border="0" cellspacing="0" cellpadding="0" class="dialog_wdkb_nr">
						<tr>
							<td height="32" width="190">授课教师</td>
							<td width="216">姓名</td>
							<td width="188">班级</td>
						</tr>
						<tr ng-repeat='student in unEvaluation.studentList'>
							<td height="32" ng-bind-html='student.teacherName | checkTdEmpty'></td>
							<td ng-bind-html='student.studentName | checkTdEmpty'></td>
							<td ng-bind-html='student.className | checkTdEmpty'></td>
						</tr>
					</table>
					</div>
					<div class="dialog_wdkb_mar_fh" style="margin-bottom: 10px;margin-top: 10px;">
						<a href="#" title="" id="btnClose" onclick="easyDialog.close();">返回</a>
					</div>
				</div>
			</div>
			
			<div class="dialog_wdkb_two" id="imgBox_CourseReference" style="display:none;" >
				<div class="dialog_wdkb_mar_two">
					<div id="yq_xxk_kb">
						<ul>
							<li id="tit1" onclick="showTab('yq_xxk_kb','tab_con','tit',1)" class="current">
								<div class="xxk_kb">教材信息</div>
							</li>
							<li id="tit2" onclick="showTab('yq_xxk_kb','tab_con','tit',2)">
								<div class="xxk_kb">讲义下载</div>
							</li>
							<div class="clear"></div>
						</ul>
					</div>
					<div id="tab_con1" class="tem" style="display:block;">
						<div class="tab_top">
							<table width="704" border="0" cellspacing="0" cellpadding="0">
								<tr style="display: none;">
									<td width="256" height="34">学年：<span ng-bind='courseReference.year'></span>
									</td>
									<td width="36">&nbsp;</td>
									<td width="120">学期：<span ng-bind='courseReference.term'></span>
									</td>
									<td width="68">&nbsp;</td>
									<td width="226">课程号：<span ng-bind='courseReference.courseID'></span>
									</td>
								</tr>
								<tr>
									<td height="34">课程名称：<span  ng-bind='courseReference.courseName'></span>
									</td>
									<td>&nbsp;</td>
									<td>授课教师：<span ng-bind='courseReference.teacher'></span>
									</td>
									<td>&nbsp;</td>
									<td style="display: none;">上课班级：<span ng-bind='courseReference.className'></span>
									</td>
								</tr>
							</table>

						</div>
						<div class="ipt_list" ng-repeat='book in courseReference.bookList'>
							<table width="704" border="0" cellspacing="0" cellpadding="0">
								<tr>
									<td width="72" height="38">书号：</td>
									<td width="230">
										<input type="text" ng-model="book.bookId" name="" class="ipt_list_shu">
									</td>
									<td width="60">&nbsp;</td>
									<td>教材名称：</td>
									<td width="230">
										<input type="text" ng-model="book.bookName" name="" class="ipt_list_shu">
									</td>
									<td width="20">&nbsp;</td>
								</tr>
								<tr>
									<td height="38">作者：</td>
									<td>
										<input type="text" ng-model="book.author" name="" class="ipt_list_shu">
									</td>
									<td>&nbsp;</td>
									<td>出版社：</td>
									<td>
										<input type="text" ng-model="book.publisher" name="" class="ipt_list_shu">
									</td>
									<td>&nbsp;</td>
								</tr>
								<tr>
									<td height="38">版次：</td>
									<td>
										<input type="text" ng-model="book.pubNo" name="" class="ipt_list_shu">
									</td>
									<td>&nbsp;</td>
									<td>定价：</td>
									<td>
										<input type="text" ng-model="book.price" name="" class="ipt_list_shu">
									</td>
									<td>&nbsp;</td>
								</tr>
							</table>

						</div>
						
						<div class="dialog_wdkb_mar_fh2">
							<a href="#" title="" id="btnClose" onclick="easyDialog.close();">返回</a>
						</div>
					</div>
					<div id="tab_con2" class="tem">
						<div class="tab_top tab_top_two">
							<table width="704" border="0" cellspacing="0" cellpadding="0">
								<tr style="display: none;">
									<td width="256" height="34">学年：<span ng-bind='courseReference.year'></span>
									</td>
									<td width="36">&nbsp;</td>
									<td width="120">学期：<span ng-bind='courseReference.term'></span>
									</td>
									<td width="68">&nbsp;</td>
									<td width="226">课程号：<span ng-bind='courseReference.courseID'></span>
									</td>
								</tr>
								<tr>
									<td height="34">课程名称：<span ng-bind='courseReference.courseName'></span>
									</td>
									<td>&nbsp;</td>
									<td>授课教师：<span ng-bind='courseReference.teacher'></span>
									</td>
									<td>&nbsp;</td>
									<td style="display: none;">上课班级：<span ng-bind='courseReference.className'></span>
									</td>
								</tr>
							</table>
							<table width="670" border="0" cellspacing="0" cellpadding="0" class="tab_jy_two">
								<tr>
									<td height="35" width="480">讲义</td>
									<td width="188">类型</td>
								</tr>
								<tr ng-repeat='handout in courseReference.handoutList'>
									<td height="35"><a ng-href='{{handout.url}}' target="_blank" title="" name="" class="">&nbsp;{{handout.title}}&nbsp;</a>
									</td>
									<td>&nbsp;{{handout.type}}&nbsp;</td>
								</tr>
							</table>
						</div>
						<div class="dialog_wdkb_mar_fh2">
							<a href="#" title="" id="btnClose" onclick="easyDialog.close();">返回</a>
						</div>
					</div>
				</div>
			</div>
		
			<div class="dialog_wdkb" id="imgBox_CourseTime" style="display:none;" >
				<div class="dialog_wdkb_mar" style="padding: 20px; height: auto; width: 450px">
					<p ng-bind-html='theCourseTime' style="font-size:13px; line-height: 200%; padding: 15px;padding-left: 25px"></p>
					<div class="dialog_wdkb_mar_fh2" style="width: inherit;">
						<a href="#" title="" id="btnClose" onclick="easyDialog.close();">返回</a>
					</div>
				</div>
				
			</div>
		</div>

	</div>
	<div class="clear"></div>
</div>

<script>

	var test_local = false;
	var loadingWidget = layer.load('获取数据中..');
	layer.area(loadingWidget);
	
	var ScheduleAppModule = angular.module('ScheduleApp',[]).config(function($sceProvider){
		$sceProvider.enabled(false);
	});
	moduleDirective_checkTdEmpty(ScheduleAppModule);
	moduleDirective_trustHtml(ScheduleAppModule);
	
	ScheduleAppModule.factory('ScheduleInterface',function($http){
		var _ = {};
		_.getSchedule = function(callback){	
			$http.post(psc_url + 'WEBLIB_MBA_STU.TZ_MBA_STU_COURSE.FieldFormula.IScript_getXskb',{params:{}
			}).success(function(data,status,headers,config){
				callback(data);
				return;
			}).error(function(data,status,headers,config){
				if (test_local) {callback(fakeScheduleObject); return;}
				alert('无法获取课程表！（错误码：' + status + "）" );
				callback(null);
				return;
			});
		};		
		_.getCourseAttendanceData = function(cid, callback){
			$http.post(psc_url + 'WEBLIB_MBA_STU.TZ_MBA_STU_COURSE.FieldFormula.Iscript_GetKq?' + $.param({coursId: cid}),{params:{}
			}).success(function(data,status,headers,config){
				callback(data);
				return;
			}).error(function(data,status,headers,config){
				if (test_local) {callback(fakeAttendance); return;}
				alert('无法获取考勤记录！（错误码：' + status + "）" );
				callback(null);
				return;
			});
		};
		_.getUnevaluatedStudentList = function(cid, callback){
			$http.post(psc_url + 'WEBLIB_MBA_STU.TZ_MBA_STU_KCPG.FieldFormula.Iscript_getPgsut?' + $.param({coursId: cid}),{params:{}
			}).success(function(data,status,headers,config){
				callback(data);
				return;
			}).error(function(data,status,headers,config){
				if (test_local) {callback(fakeUnevaluation); return;}
				alert('无法获取数据！（错误码：' + status + "）" );
				callback(null);
				return;
			});
		};
		_.getCourseReferenceData = function(cid, callback){
			$http.post(psc_url + 'WEBLIB_MBA_STU.TZ_MBA_STU_COURSE.FieldFormula.Iscript_CourseData?' + $.param({coursId: cid}),{params:{}
			}).success(function(data,status,headers,config){
				callback(data);
				return;
			}).error(function(data,status,headers,config){
				if (test_local) {callback(fakeReference); return;}
				alert('无法获取课程资料！（错误码：' + status + "）" );
				callback(null);
				return;
			});
		};
		return _;
	});
	
	ScheduleAppModule.controller(
		'ScheduleController',
		function($scope,ScheduleInterface){
			var defaultStudentSchedule = {
				studentId : '',
				className : '',
				graDate : '',
				courseList : []
			};
			
			var studentSchedule = $.extend(true, {}, defaultStudentSchedule);
			$scope.studentSchedule = studentSchedule;
			$scope.theCourseTime = '';
			
			/* init Schedule */
			ScheduleInterface.getSchedule(function(data){
				if (data) {
					$scope.studentSchedule = data;
				}
				layer.closeAll();
			});
			
			/* init unEvaluation */
			var emptyUnEvaluation = {
				courseId : '',
				courseName : '',
				teacher : '',
				studentList : []
			};
			$scope.unEvaluation = $.extend(true, {}, emptyUnEvaluation);
			$scope.openUnevaluatedStudentList = function (cid){
				loadingWidget = layer.load('获取数据中..');
				layer.area(loadingWidget);
				
				ScheduleInterface.getUnevaluatedStudentList(cid, function(data){
					if (data && data.teacherList){
						var studentList = [];
						/* i tried ng-repeat='student in studentList in teacherList' , which doesn't work  */
						for (var i = 0; i < data.teacherList.length; i ++){
							if (!data.teacherList[i].studentList.length) continue;
							for (var j = 0; j < data.teacherList[i].studentList.length; j ++){
								studentList.push($.extend({teacherName : data.teacherList[i].teacher},$.extend(true, {}, data.teacherList[i].studentList[j])));
							}
						}
						data.studentList = studentList;
						$scope.unEvaluation = data;
						
						delayOpenDialogBy100("imgBox_UnevaluatedStudentList");
						setTimeout(function(){
							$("#imgBox_UnevaluatedStudentList .dialog_wdkb_nr_wrapper").css("max-height","500px");
							$("#imgBox_UnevaluatedStudentList .dialog_wdkb_nr_wrapper").css("overflow-y","scroll");
							$("#imgBox_UnevaluatedStudentList .dialog_wdkb_nr_wrapper").scrollTop(0);
						},30);
					}
					layer.closeAll();
				});
			};
			
			/* init Reference */
			var emptyReference = {
				year : '',
				term : '',
				courseID : '',
				courseName : '',
				teacher : '',
				className : '',
				bookList : [],
				handoutList : []
			};
			$scope.courseReference = $.extend(true, {}, emptyReference);
			$scope.openCourseReference = function(cid){
				loadingWidget = layer.load('获取数据中..');
				layer.area(loadingWidget);
				ScheduleInterface.getCourseReferenceData(cid, function(data){
					if (data){
						$scope.courseReference = data;
						delayOpenDialogBy100("imgBox_CourseReference");
					}
					layer.closeAll();
				});
			};
			
			/* init Attendance */
			var statusNormal = '正常';
			var emptyAttendance = {
				year : '',
				term : '',
				courseName : '',
				teacher : '',
				importTime : '',
				KQList : []
			};
			$scope.courseAttendance = $.extend(true, {}, emptyAttendance);
			$scope.openCourseAttendance = function(cid){
				ScheduleInterface.getCourseAttendanceData(cid, function(data){
					loadingWidget = layer.load('获取数据中..');
					layer.area(loadingWidget);
					if (data){
						$scope.courseAttendance = data;
						delayOpenDialogBy100("imgBox_CourseAttendance");
					}
					layer.closeAll();
				});
			};
			
			$scope.openCourseTime = function(index){
				var courseTimeData = $scope.studentSchedule.courseList[index].courseTime;
				$scope.theCourseTime = courseTimeData;
				delayOpenDialogBy100("imgBox_CourseTime");
				setTimeout(function(){
					$("#imgBox_CourseTime").parent().css("margin-left","-240px");
				},130);
			}
		}
	);
</script>

<!--TODO : endCopy-->
<div class="footer">
	<div class="ft_box">
      <div class="ft_box_l">
        <h2>帮助中心:</h2>
        <p class="bzzx"><a href="#" title="" class="bzzx1">可以注册多个账号么？</a>/ <a href="#" title="">填写信息需要使用中文还是英文？ </a>/ <a href="#" title="">密码忘记后如何找回？ </a>/ <a href="#" title="">系统显示乱码或出错怎么办？</a></p>
        <div class="ft_list">
          <ul>
            <li style="margin-left:-8px;"><a href="#" title="">关羽安泰</a></li>
            <li><a href="#" title="">网站地图</a></li>
            <li><a href="#" title="">友情链接</a></li>
            <li><a href="#" title="">帮助中心</a></li>
            <li style="background:none;"><a href="#" title="">联系我们</a></li>
          </ul>
          <a href="#" title="" class="ft_box_r">
            <img src="images/login_5.jpg" width="238" height="50">
          </a>
        </div>
        <p class="bqsy">Copyright 2011-2014 © 上海交通大学安泰经济与管理学院</p>
      </div>
      <div class="clear"></div>
    </div>
</div>

</body>
</html>
